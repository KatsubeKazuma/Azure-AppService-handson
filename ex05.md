# 演習 5 : REST API サービスと SPA のホスト

クライアントからのリクエストに対し、HTML ページを返すのではなく、処理の結果を特定のデータ形式で返す Web API と呼ばれるアプリケーションがあります。

Web API の機能は一般的に 「REST (REpresentational State Transfer) の 4 原則」にもとづき GET、POST、PUT、DELETE などの HTTP メソッドに準拠して実装されており、処理結果は JSON や XML などのデータ形式で結果を返します。

一方、クライアント側では、サーバーサイドでの HTML の生成は行わず、Web API から返されたデータをもとに、クライアント サイドで JavaScript などで動的に HTML を生成し、ユーザーにインタラクションを提供するものがあります。このタイプの Web アプリケーションは画面の描画にページ遷移を必要としないため SPA (Single Page Application) と呼ばれます。

上記 2 つのアプリケーションはいずれも Azure App Service でホストすることができますが、不特定多数のユーザーに対してサービスを提供する場合、より効率的に運用するための機能を追加したり、より安価で自由度の高い配置を行うこともできます。

この演習では Azure API Management を使用して Web API アプリケーションへのトラフィックを制御(スロットリング)する方法と、SPA をより安価な Azure Storage でホストする方法を学習します。

この演習では以下のタスクを実行します。

- Azure API Management を使用して Web API アプリケーションへのトラフィックを制御する
- Azure Storage を使用して SPA をホストする

<br>

## タスク 1 : Azure API Management を使用して Web API アプリケーションへのトラフィックを制御する

Microsoft Azure API Management は、すべての API に対する "フロント ドア" として機能します。 

Azure API Management を使用することで複数の Web API アプリを統合し、クライアント アプリケーションに対して統一されたエンドポイントを提供することができます。また、API のセキュリティ、スロットリング、モニタリング、分析などの機能を提供します。

このタスクでは、Azure API Management を使用して Web API アプリケーションのサービスをホストする基本的な手順を学習します。

### タスク 1.1 : Azure API Management サービスを作成する

Azure API Management サービスのインスタンスを作成します。

なお、Azure API Management サービスのデプロイには時間がかかりますので、この手順は早めに実行しておくことをお勧めします。

具体的な手順は以下の通りです。


1. [Azure Portal](http://portal.azure.com) にログインします。

2. ポータル画面上部の \[**+**\] リソースの作成 アイコンか、表示されていない場合は画面左上のハンバーガーメニューをクリックし、\[**リソースの作成**\] をクリックします

    ![Create Resource](images/23aug_create_AzureResource.png)

3. 検索バーに `API Management`と入力し、表示された「API Management」をクリックします

    ![Search API Management](images/APIManagement_tail.png)


4. \[**API Management**\] の画面に遷移するので \[**作成**\] をクリックします

5. API Management の作成画面に遷移するで各項目を以下のように設定します

    |項目|値|
    |---|---|
    |サブスクリプション \* |使用するサブスクリプション|
    |リソース グループ \* |`PaaS_Handson`|
    |リージョン \* | \[**(Asia Pacific) Japan East**\] |
    |リソース名 \*|`handson-apim-xyz`(※1)|
    |Organization name \*|`PaaSHandson`|
    |管理者のメール アドレス|自身のメールアドレス|
    |価格レベル|\[**Developer(SLA なし)**\]|

    ※1: `handson-apim-xyz` の `xyz` には自分のイニシャルなどを入力してください。

    <img src="images/apim_create.png" width="700px">

    設定が完了したら画面下部の \[**確認と作成**\] ボタンをクリックし、\[**作成**\] ボタンが表示されたらクリックします。

    API Management サービスのデプロイには 20 分前後かかる場合があり、そのため完了の通知はメールでも行われます。

<br>

### タスク 1.2 : API の公開

API Management サービスを使用して MovieApp の API を公開します。

なお、MovieApp-XYZ は演習 4 でプライベート リンクの仮想ネットワーク内からしかアクセスできなっているので、このタスクでは作業を単純にすために MovieApp-XYZ のステージングスロットのインスタンスである MovieApp-XYZ-Staging を使用します。

このタスクを実行する前に、ステージング スロットの URL に問題なくアクセスできることを確認してください。URL は以下の URL の `movie-app-xyz-staging` の **xyz** 部分をご自身のアプリケーション名に変更したものになります。

```
https://movieapp-xyz-staging.azurewebsites.net/api/movie
```

API Management サービスを使用して MovieApp-XYZ-Staging の API を公開する手順は以下の通りです。

1. 作成した API Management サービスのリソース画面の左側メニューから \[**APIs**\] をクリックします

2. \[**+ API**\] をクリックし、画面左の **Define a new API** で \[**HTTP**\] のタイルをクリックします

    <img src="images/apim_AddAPI.png" ait="API Management サービスへの API の追加" width="800px">

3. \[**Create an HTTP API**\] のダイアログ ボックスがポップアップするので、以下のように設定します

    |項目|値|
    |---|---|
    |\* Display name|`MovieApp API`|
    |\* Name|`movieapp-api`|
    |Web service URL|`https://movieapps-xyz-staging.azurewebsites.net/api/`|
    |API URL suffix|既定のまま|

    <img src="images/apim-CreateHTTP-API.png" ait="API Management サービスへの API の追加" width="800px">

    設定が完了したら \[**Create**\] ボタンをクリックします

4. 作成した **MovieApp API** の画面に遷移するので、画面左の[**Design**\]　タブの \[**Add Operation**\] をクリックし、\[**Frontend**\] 画面の各項目を以下のように設定します

    |項目|値|
    |---|---|
    |\* Display name|`getMovieList`|
    |\* Name|`getMovieList`|
    |\* URL| \[**GET**\] `movie`|
    |Description|`映画の一覧を取得します`|
    |Tags|既定のまま|

    <img src="images/apim-add-operations.png" ait="API Management サービスへの API の追加" width="800px">

    設定が完了したら \[**Save**\] ボタンをクリックします 

5. 作成した `getMovieList` メソッドが選択された状態になっているので、画面上部の \[**Test**\] タブをクリックし、画面下部の \[Send\] ボタンをクリックします

    <img src="images/apim-api-test.png" ait="API Management サービスへの API の追加" width="800px">

    API の呼び出し結果が正しく返ることを確認します

    <img src="images/apim-result-getMovieList-.png" width="500px">

    次のタスクで使用するために **Request URL** をメモしておきます。

    <img src="images/apim_RequestURL.png" width="500px">

ここまでの手順で、Azure API Management サービスを使用して Web API アプリケーションのサービスをホストする基本的な手順は完了です。

<br>

## タスク 1.3 : HTTP クライアントからの呼び出し

タスク 1.2 で作成した API を HTTP クライアントから呼び出してみます。

curl コマンドを使用しても良いですが、ここでは Visual Studio Code の REST Client 拡張 を使用して呼び出します。

タスクを実行する前に以下のページから REST Client 拡張をインストールしてください。

* [**REST Client - Visual Studio Marketplace**](https://marketplace.visualstudio.com/items?itemName=humao.rest-client)

Visual Studio Code から REST Client 拡張を使用して API Management に作成した API を呼び出します。

具体的な手順は以下の通りです。

1. Visual Studio Code を起動します。

    画面左のツールバーの最上部にあるエクスプローラー アイコンをクリックし、表示されたブレードの \[**フォルダーを開く**\] をクリックして任意の作業フォルダーを指定します。

    <img src="images/vscodeOpenFolder.png" width="500px">

2. エクスプローラー画面で、フォルダー名の右側に表示される \[**新しいファイル**\] アイコンをクリックして、**Call-HandsonAPI.http** という名前でファイルを作成します

    <img src="images/VSCode_Create_HttpFile.png" width="500px">


3. REST Client 拡張の動作を確認するために作成したファイル ***all-HandsonAPI.http** に以下の内容をコピーして貼り付けます。なお指定している URL は [Dummy Rest API Example](https://dummy.restapiexample.com/) が提供しているダミーの結果を返す API のエンドポイントです。

    ```http
    //API の Endpoint
    GET https://dummy.restapiexample.com/api/v1/employees
    ```
4. 記述したエンドポイントの上部の \[**Send Request**\] をクリックして API を呼び出します
    
    <img src="images/VSCode_RESTClient_sendRequest.png" width="500px">

    画面右側にタブが開き、API の呼び出し結果が表示されることを確認します

5. 前の手順で記述したダミー API のエンドポイントを、タスク 1.2 で作成した API Management のエンドポイントに変更して実行し、**HTTP/1.1 401 Access Denied** で失敗することを確認します。

    <img src="images/vscode_restClient_http401.png" width="500px">

    **"message"** にサブスクリプション キーが設定されていないためアクセスが拒否されたことが表示されます。

    これは、API Management で API を公開した際の初期設定がサブスクリプション キーを要求するようになっているためです。

6. API Management の設定箇所の確認を行います。

    この演習で作成した API Management サービス **handson-apim-xyz**  のリソース画面の左側メニューから \[**APIs**\] をクリックします。

7. 画面左の API の一覧から **MovieAPP API** をクリックし、画面上部のメニューから \[**Settings**\] をクリックします

    項目 **Subscription** で \[**Subscription required**\] にチェックが入っていることを確認します。

    <img src="images/apim-api-setting.png">

    上記チェック ボックスが有効な場合、API Management で公開した API にアクセスする際には、HTTP リクエスト ヘッダーの `Ocp-Apim-Subscription-Key` かクエリーストリンク `subscription-key` にサブスクリプション キーを指定する必要があります。

    チェックを外すとサブスクリプション キーの指定が不要になりますが、この演習はこのままの設定で行います。

8. API を呼び出すためのサブスクリプション キーを入手します

    画面左のメニューから \[**サブスクリプション**\] をクリックします

9. \[**サブスクリプション**\] の画面に遷移し、サブスクリプションの一覧が表示されます

    既定ではリストにある `Built-in all-access subscription` のキーが使用されていますが、呼び出しに使用するとすべての API にアクセスできるため、セキュリティ上の理由から新しいサブスクリプションを作成します。

    画面上部の \[**+ サブスクリプションの追加**\] をクリックします

10. 画面右側に \[**新しいサブスクリプション**\] のブレードが表示されるので各項目を以下のように設定

    |項目|値|
    |---|---|
    |名前|`MoveApp-XYZ`|
    |表示名|`MoveApp-XYZ の API`|
    |トレースを許可|チェックしない|
    |スコープ|\[**API**\]|
    |ユーザー|指定しない|

    <img src="images/apim-api-newSubscription.png" >

    設定が完了したら \[**作成**\] ボタンをクリックします

11. 作成したサブスクリプションがリストに表示されるので、リスト右端にある \[**・・・**\] メニューをクリックし、表示されたコンテキスト メニューから \[**キーの表示/非表示**\] をクリックします

    <img src="images/apim_visible_subcsription.png" width="1000px">

12. サブスクリプション キーが表示されるので、コピーボタンを使用してキーをコピーし、メモしておきます

    <img src="images/apim_visibled_subscriptionKey.png" width="700px"> 

12. Visual Studio Code でオープンしている ファイル **Call-HandsonAPI.http** の先頭に以下の記述を追加し、%SubscriptionKey% をコピーしたサブスクリプション キーに置き換えます

    ```http
    //API の サブスクリプション キー
    @subscriptionKey= %SubscriptionKey%
    ```

    同様に API のエンドポイントの記述のすぐ下に以下の記述を追加します

    ```http
    Ocp-Apim-Subscription-Key: {{subscriptionKey}}
    ```

    以下は記述例です

    ```http
    //API の サブスクリプション キー
    @subscription = d061e7546f474d01a2ebf2802b3a9ba0

    GET https://handson-apim-xyz.azure-api.net/movie
    Ocp-Apim-Subscription-Key : {{subscription}}
    ```


13. 記述したエンドポイントの上部の [Send Request] をクリックして API を呼び出します

    <img src="images/VSCode_RESTClient_sendRequest2.png" width="500px">

    画面右側にタブが開き、API の呼び出し結果が表示されることを確認します

    <img src="images/vscode_restClient_http200.png" width="500px">

ここまでの手順でサブスクリプション キーの作成と、サブスクリプションキーを使用して API Management で公開した API を呼び出す手順は完了です。

この手順ではサブスクリプションキーを使用して API のアクセス制御を行っていますが、この方法を SPA で使用する場合には、ユーザーが Web ブラウザーの開発者ツールなどを使用してサブスクリプションキーを不正に取得する可能性があるため、セキュリティ上のリスクがあります。

その場合には、IP アドレス制限や認証を使用したアクセス制御を検討することが必要です。

詳しくは以下のリンクを参照してください。

* [**呼び出し元 IP を制限する**](https://learn.microsoft.com/ja-jp/azure/api-management/ip-filter-policy)

* [**Azure API Management での API への認証と認可**](https://learn.microsoft.com/ja-jp/azure/api-management/authentication-authorization-overview)

* [**証明書を使用して API をセキュリティで保護する**](https://learn.microsoft.com/ja-jp/training/modules/explore-api-management/7-secure-access-api-certificates)
   
* [**クライアント証明書を使用して、API へのアクセスをセキュリティで保護する**](https://learn.microsoft.com/ja-jp/training/modules/control-authentication-with-apim/4-secure-access-client-certs)


<br>


## タスク 1.4 : 入出力処理ポリシーの追加









[バックエンド API を作成する](https://learn.microsoft.com/ja-jp/training/modules/explore-api-management/8-exercise-import-api)


[API をインポートおよび発行する](https://learn.microsoft.com/ja-jp/training/modules/publish-manage-apis-with-azure-api-management/4-import-and-publish-an-api)

[API の応答から技術情報を削除する](https://learn.microsoft.com/ja-jp/training/modules/protect-apis-on-api-management/2-remove-technical-info)

[API 要求をスロットリングする](https://learn.microsoft.com/ja-jp/training/modules/protect-apis-on-api-management/6-rate-limit-policy)







シナリオ

1. API Management サービスを作成する
2. Web API アプリケーションをインポートする
3. サブスクリプションキーを使用したアクセス







