# 演習 5 : REST API サービスと SPA のホスト

クライアントからのリクエストに対し、HTML ページを返すのではなく、処理の結果を特定のデータ形式で返す Web API と呼ばれるアプリケーションがあります。

Web API の機能は一般的に 「REST (REpresentational State Transfer) の 4 原則」にもとづき GET、POST、PUT、DELETE などの HTTP メソッドに準拠して実装されており、処理結果は JSON や XML などのデータ形式で結果を返します。

一方、クライアント側では、サーバーサイドでの HTML の生成は行わず、Web API から返されたデータをもとに、クライアント サイドで JavaScript などで動的に HTML を生成し、ユーザーにインタラクションを提供するものがあります。このタイプの Web アプリケーションは画面の描画にページ遷移を必要としないため SPA (Single Page Application) と呼ばれます。

上記 2 つのアプリケーションはいずれも Azure App Service でホストすることができますが、不特定多数のユーザーに対してサービスを提供する場合、より効率的に運用するための機能を追加したり、より安価で自由度の高い配置を行うこともできます。

この演習では Azure API Management を使用して Web API アプリケーションへのトラフィックを制御(スロットリング)する方法と、SPA をより安価な Azure Storage でホストする方法を学習します。

この演習では以下のタスクを実行します。

- Azure API Management を使用して Web API アプリケーションへのトラフィックを制御する
- Azure Storage を使用して SPA をホストする

<br>

## タスク 1 : Azure API Management を使用して Web API アプリケーションへのトラフィックを制御する

Microsoft Azure API Management は、すべての API に対する "フロント ドア" として機能します。 

Azure API Management を使用することで複数の Web API アプリを統合し、クライアント アプリケーションに対して統一されたエンドポイントを提供することができます。また、API のセキュリティ、スロットリング、モニタリング、分析などの機能を提供します。

このタスクでは、Azure API Management を使用して Web API アプリケーションのサービスをホストする基本的な手順を学習します。

### タスク 1.1 : Azure API Management サービスを作成する

Azure API Management サービスのインスタンスを作成します。

なお、Azure API Management サービスのデプロイには時間がかかりますので、この手順は早めに実行しておくことをお勧めします。

具体的な手順は以下の通りです。


1. [Azure Portal](http://portal.azure.com) にログインします。

2. ポータル画面上部の \[**+**\] リソースの作成 アイコンか、表示されていない場合は画面左上のハンバーガーメニューをクリックし、\[**リソースの作成**\] をクリックします

    ![Create Resource](images/23aug_create_AzureResource.png)

3. 検索バーに `API Management`と入力し、表示された「API Management」をクリックします

    ![Search API Management](images/APIManagement_tail.png)


4. \[**API Management**\] の画面に遷移するので \[**作成**\] をクリックします

5. API Management の作成画面に遷移するで各項目を以下のように設定します

    |項目|値|
    |---|---|
    |サブスクリプション \* |使用するサブスクリプション|
    |リソース グループ \* |`PaaS_Handson`|
    |リージョン \* | \[**(Asia Pacific) Japan East**\] |
    |リソース名 \*|`handson-apim-xyz`(※1)|
    |Organization name \*|`PaaSHandson`|
    |管理者のメール アドレス|自身のメールアドレス|
    |価格レベル|\[**Developer(SLA なし)**\]|

    ※1: `handson-apim-xyz` の `xyz` には自分のイニシャルなどを入力してください。

    <img src="images/apim_create.png" width="700px">

    設定が完了したら画面下部の \[**確認と作成**\] ボタンをクリックし、\[**作成**\] ボタンが表示されたらクリックします。

    API Management サービスのデプロイには 20 分前後かかる場合があり、そのため完了の通知はメールでも行われます。

<br>

### タスク 1.2 : API の公開

API Management サービスを使用して MovieApp の API を公開します。

なお、MovieApp-XYZ は演習 4 でプライベート リンクの仮想ネットワーク内からしかアクセスできなっているので、このタスクでは作業を単純にすために MovieApp-XYZ のステージングスロットのインスタンスである MovieApp-XYZ-Staging を使用します。

このタスクを実行する前に、ステージング スロットの URL に問題なくアクセスできることを確認してください。URL は以下の URL の `movie-app-xyz-staging` の **xyz** 部分をご自身のアプリケーション名に変更したものになります。

```
https://movieapp-xyz-staging.azurewebsites.net/api/movie
```

API Management サービスを使用して MovieApp-XYZ-Staging の API を公開する手順は以下の通りです。

1. 作成した API Management サービスのリソース画面の左側メニューから \[**APIs**\] をクリックします

2. \[**+ API**\] をクリックし、画面左の **Define a new API** で \[**HTTP**\] のタイルをクリックします

    <img src="images/apim_AddAPI.png" ait="API Management サービスへの API の追加" width="800px">

3. \[**Create an HTTP API**\] のダイアログ ボックスがポップアップするので、以下のように設定します

    |項目|値|
    |---|---|
    |\* Display name|`MivieApp API`|
    |\* Name|`movieapp-api`|
    |Web service URL|`https://movieapps-xyz-staging.azurewebsites.net/api/`|
    |API URL suffix|既定のまま|

    <img src="images/apim-CreateHTTP-API.png" ait="API Management サービスへの API の追加" width="800px">

    設定が完了したら \[**Create**\] ボタンをクリックします

4. 作成した **MivieApp API** の画面に遷移するので、画面左の[**Design**\]　タブの \[**Add Operation**\] をクリックし、\[**Frontend**\] 画面の各項目を以下のように設定します

    |項目|値|
    |---|---|
    |\* Display name|`getMovieList`|
    |\* Name|`getMovieList`|
    |\* URL| \[**GET**\] `movie`|
    |Description|`映画の一覧を取得します`|
    |Tags|既定のまま|

    <img src="images/apim-add-operations.png" ait="API Management サービスへの API の追加" width="800px">

    設定が完了したら \[**Save**\] ボタンをクリックします 

5. 作成した `getMovieList` メソッドが選択された状態になっているので、画面上部の \[**Test**\] タブをクリックし、画面下部の \[Send\] ボタンをクリックします

    <img src="images/apim-api-test.png" ait="API Management サービスへの API の追加" width="800px">

    API の呼び出し結果が正しく返ることを確認します

    <img src="images/apim-result-getMovieList-.png" width="500px">














https://learn.microsoft.com/ja-jp/training/modules/introduction-to-azure-api-management/1-introduction

[証明書を使用して API をセキュリティで保護する](https://learn.microsoft.com/ja-jp/training/modules/explore-api-management/7-secure-access-api-certificates)

[バックエンド API を作成する](https://learn.microsoft.com/ja-jp/training/modules/explore-api-management/8-exercise-import-api)


[API をインポートおよび発行する](https://learn.microsoft.com/ja-jp/training/modules/publish-manage-apis-with-azure-api-management/4-import-and-publish-an-api)

[API の応答から技術情報を削除する](https://learn.microsoft.com/ja-jp/training/modules/protect-apis-on-api-management/2-remove-technical-info)

[API 要求をスロットリングする](https://learn.microsoft.com/ja-jp/training/modules/protect-apis-on-api-management/6-rate-limit-policy)

[クライアント証明書を使用して、API へのアクセスをセキュリティで保護する](https://learn.microsoft.com/ja-jp/training/modules/control-authentication-with-apim/4-secure-access-client-certs)






シナリオ

1. API Management サービスを作成する
2. Web API アプリケーションをインポートする
3. サブスクリプションキーを使用したアクセス







