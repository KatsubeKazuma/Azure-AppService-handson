# 演習 2 : Web サイトを運用するための基本的な設定

この演習では、[演習 1](ex01.md) で Azure App Servive(Web App) に移行した アプリケーションを Web サイトとして運用するための基本的な設定を行います。

この演習では、一般的な Web サイトでコンテンツをホストする際に必要となる以下の基本的な内容について手順を実施します。ただし、ドメインの購入など実施がむつかしいものについては手順の説明のみを行います。

* App Service ログの設定と有効化
* バックアップ
* カスタム ドメインの設定
* CORS 設定
* 認証について

<br>

## タスク 1 : App Service ログの設定と有効化

一般的な Web サーバーの場合、既定の状態でアクセスログやエラーログなどのログが出力されますが、App Service では既定ではログが出力されないため、ログの設定と有効化を行う必要があります。

ログの出力先は Azure Storage (Blob) と  App Service ファイル システムの 2 種類がありますがこのタスクでは Azure Storage アカウントを使用します。

ログの出力先となる Azure Storage アカウントは \[**App Service ログ**\]の設定画面から作成することもできますが、混乱を避けるためにAzure Storage アカウントの作成と、\[**App Service ログ**\] の設定手順を別けて説明します。

はじめに Azure Storage アカウントを作成します。

具体的な手順は以下の通りです。

### タスク 1.1 : Azure Storage アカウントの作成

1. [Azure Portal](http://portal.azure.com) にログインします。

2. ポータル画面上部の \[**+**\] リソースの作成 アイコンか、表示されていない場合は画面左上のハンバーガーメニューをクリックし、\[**リソースの作成**\] をクリックします

    <img src="images/23aug_create_AzureResource.png" width="500px">

3. \[**リソースの作成**\] 画面に遷移するので、検索ボックスに `ストレージ` と入力し、表示された検索結果の \[**ストレージ アカウント**\] のタイルをクリックします

    <img src="images/storage_find_result.png" width="500px" border="1">

4. \[**ストレージ アカウント**\] の画面が表示されるので、\[**作成**\] ボタンをクリックします

5. \[**ストレージ アカウントを作成する**\] 画面に遷移するので、各項目を以下の通り入力します

    |項目|値|
    |---|---|
    |サブスクリプション|使用するサブスクリプション|
    |リソース グループ|`PaaS_Handson`|
    |ストレージ アカウント名|`handsonstorage99`(※1)|
    | 地域 * | \[**(Asia Paciffic) Japan East**\] |
    |パフォーマンス|\[**Standard**\]|
    |冗長性|\[**ローカル冗長ストレージ(LRS)**\](※2)|
    |ロケーション|使用するリージョン|

    (※1) この名前はユニークでかつ小文字英数字しか使用できないため、数字 `99` を任意の数字に書き換えてください。

    (※2) 今回は演習で使用するため価格の安い LRS を指定しています。実際に運用する際は、データの重要度に応じて GRS などの冗長性の高いものを選択してください。

    <img src="images/storage_create_settings.png" width="700px" border="1">

    \[**レビュー**\] ボタンをクリックし、\[**作成**]\ ボタンが表示されたらクリックしデプロイを開始します。

6. デプロイが完了すると \[**リソースに移動**\] ボタンが表示されるので、クリックして作成された Azure Storage アカウントの画面に遷移します

7. 画面左のメニューバーから \[**コンテナー**\] をクリックし、遷移した画面上部にある \[ **+ コンテナー**\] ボタンをクリックします

    画面右側に \[**新しいコンテナー**\] ブレードが表示されるので、以下の 2 つの名前のコンテナーをそれぞれ作成します

    * **log-server**
    * **log-app**

    > 【メモ】既定で $logs という名前のコンテナーが作成されていることがありますが、このコンテナーは Azure Storage Analytics ログを保存するもので削除することはできません。詳しくは以下のドキュメントを参照してください。
    > * [Azure Storage Analytics ログ - ログの保存方法](https://learn.microsoft.com/ja-jp/azure/storage/common/storage-analytics-logging#how-logs-are-stored)

    <img src="images/storage_blob_containar_new.png" width="700px">

ここまでの手順で Azure Storage アカウントの作成と、ログを保存するためのコンテナーの作成が完了です。

次に App Service のログの設定を行います。

### タスク 1.2 : App Service ログの設定

1. [Azure Portal](http://portal.azure.com) にログインします

2. [演習 1 のタスク 3](ex01.md#%E3%82%BF%E3%82%B9%E3%82%AF-3-appservice-%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%AE%E4%BD%9C%E6%88%90) で作成した App Service **MovieApp-** XYZ の設定画面を開きます

3. 画面左側のメニューから \[**App Service ログ**\] をクリックします

    遷移した画面で \[**アプリケーション ログの記録 (BLOB)**\] トグルボタンを \[**オン**\] にし、 項目 \[**ストレージ コンテナー**\] の下にある \[**()**\] リンクをクリックします

    <img src="images/AppService_setting_AppLog.png" width="700px">

4. ストレージ アカウントの一覧が表示されるので タスク 1.1 で作成し
た `handsonstorage99` をクリックします

    続いてコンテナーの一覧が表示されるので、\[**log-app**\] コンテナーを選択し、\[**選択**\] ボタンをクリックします

    <img src="images/AppService_log_Storage_setting01.png" width="700px">

5. \[**App Service ログ**\] の画面に戻るので、\[**リテンション機関 (日)\***\] を任意の日数に設定します

6. \[**サーバー ログ**\] のトグルボタンを \[**ストレージ**\] にし、 項目 \[**ストレージ コンテナー**\] の下にある \[**()**\] リンクをクリックします

    この手順の 4 と同様に、ストレージ アカウントの一覧が表示されるので `handsonstorage99` をクリックし、コンテナーの一覧が表示されるので、\[**log-server**\] コンテナーを選択し、\[**選択**\] ボタンをクリックします
    
7. \[**App Service ログ**\] の画面に戻るので、\[**リテンション機関 (日)\***\] を任意の日数に設定します

8. \[**詳細なエラー メッセージ**\]、\[**失敗した要求のトレース**\] のトグルボタンを \[**オン**\] にし、画面上部にある \[**保存**] ボタンをクリックします

    ここまでの手順で App Service のログの設定が完了です。
<br>

### タスク 1.3 : App Service ログの取得と確認

実際に App Service のアプリケーションにアクセスを行い Web サーバーログにアクセスログを、アプリケーションにエラーを発生させアプリケーションログに情報を取得します。

手順は以下のとおりです。

1. 画面左側のメニューから \[**概要**\] をクリックし、遷移した画面の \[**既定のドメイン**\] リンクをクリックし、Web ブラウザで App Service のアプリケーションにアクセスします

2. アプリケーションの画面が表示されたら、画面上部の \[**Create New**\] リンクをクリックしします。
    
    <img src="images/MovieApp_CreateNew.png" width="500px">

    映画情報の新規登録画面に任意の情報を入力して \[**Create**\] ボタンをクリックすると最初の画面に遷移するので追加した映画がリストに表示されていることを確認します。

3. Web ブラウザーのアドレスバーに表示されているアプリケーションの URL を以下のように書き換え、SPA の画面を表示します。ドメイン名の後ろに `/index.html` を必ず付けてください。

    `https://<App Service の名前>.azurewebsites.net/index.html`

    アプリケーションのタイトルが `Movies SPA` に変わっていることを確認します

    この SPA で使用している編集 API は HTTP500 エラーを返すようになっているのでこれを使用してエラーを発生させ、アプリケーション ログにエラー情報を取得します

4. リストされている映画のタイトルから、このタスクで追加した映画の \[**Edit**\] リンクをクリックし、遷移した編集画面で \[**Save**\] ボタンをクリックします

   画面は遷移しませんが、エラーは発生しているので、以降の手順でログに記録されているエラーを確認します。

5. この演習の[タスク 1.1](#%E3%82%BF%E3%82%B9%E3%82%AF-11--azure-storage-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90) で作成した Azure Storage アカウントの画面を開き、画面左側のメニューから \[**コンテナー**\] をクリックします

6. コンテナーの一覧が表示されるので、\[**log-server**\] コンテナーをクリックします
    
7. \[**log-server**\] コンテナーの下には、'MovieApp-**XYZ**' という名前のフォルダーが作成されており、さらに年/月/日の数字のフォルダーが作成されており、その中にログファイルである *.log が作成されているのでクリックします

8. ログファイルの概要が表示されるので、画面上部のメニューから \[**ダウンロード**\] をクリックして *.log ファイルをダウンロードします

    <img src="images/Storage_dl_serverlog.png" width="700px">

9. ダウンロードした *.log ファイルをテキストエディターで開き、HTTP リクエストについてのログが記録されていることを確認します

    <img src="images/AppService_server_logfile.png" width="700px">

    Web サーバー ログのデータはスペース区切りのテキスト形式で保存されています。

10. この演習の 6 から 9 の手順をコンテナー **log-app** に対しても行います

    アプリケーションログの拡張子は *.txt なのでサーバーログと同様にテキストエディターで内容を確認することができます。

    <img src="images/AppService_app_logfile.png" width="700px">

    この演習で取得したアプリケーション ログには **Edit** 機能を使用した際に発生した HTTP500 エラーのトレースログが出力されており、エラーの原因が、SQL の UPDATE 文の実行時に書き込み不可の ID を更新使用としてエラーになっていることがわかります。

このように App Service のログを Azure Storage に保存することで、リクエストの状態や、アプリケーションのトラブルシューティングを行うことができます。

最後に App Service 画面左のメニューから \[**Azure Advisor**\] をクリックし、遷移した画面で '選択したサブスクリプションとリソースについて、すべての推奨事項に従っています。' と表示されているのを確認します。

<img src="images/AppService-Advisor.png" width="700px">

<br>

演習 2 タスク 1 : App Service ログの設定と有効化 の作業は以上です。このタスクでは App Service のログを保存するための Azure Storege アカウントの作成とコンテナーの作成、App Service のログの設定と有効化を行いました。

これで実際のサーバー上で Web サーバーを運用する際と同等のログが取得できるようになりました。

なお、Azure のメリットを活かした、より詳しいログの設定と監視方法については、演習 3 で行います。

<br>

## タスク 2 : バックアップ

Web サイトの情報が誤って削除された場合や、Web サイトの構成が変更されてしまった場合などに備えて、バックアップを取得することができます。

### 演習の準備

Azure App Service でバックアップ機能を利用するには App Servoce プランの変更が必要です。この作業は App Service の \[**バックアップ**\] を選択した際、無料のサブスクリプションを使用していると表示される \[**今すぐアップグレードする**\] ボタンをクリックすることで行うことができますが、今回は一般的な方法であるメニュー \[**App Service プランの変更**\] から行います。

具体的な手順は以下の通りです。

1. App Service の画面左側のメニューから \[**App Service プランの変更**\] をクリックします

2. 遷移した画面で項目 \[**価格レベル**\] の横に表示されている `Free (F1)` リンクをクリックします

3. \[**スペックの選択**\] ブレードが表示されるので、\[**運用**\] タブをアクティブにし、同タブ内の項目 \[**推奨される価格レベル**\] で \[**S1**\] タイルをクリックします

    \[**適用**\] ボタンをクリックすると \[**App Service プランの変更**\] 画面に戻るので\[**OK**\] ボタンをクリックします

    <img src="images/AppService_plan_change.png" width="1000px">

以上で App Service プランの変更は完了です。

### バックアップの取得とリストア

バックアップの取得とリストアについては公式ドキュメントの手順を参照しして作業を行います。



















