# 演習 2 : Web サイトを運用するための基本的な設定

この演習では、[演習 1](ex01.md) で Azure App Servive(Web App) に移行した アプリケーションを Web サイトとして運用するための基本的な設定を行います。

この演習では、一般的な Web サイトでコンテンツをホストする際に必要となる以下の基本的な内容について手順を実施します。ただし、ドメインの購入など実施がむつかしいものについては手順の説明のみを行います。

* App Service ログの設定と有効化
* バックアップ
* カスタム ドメインの設定
* CORS 設定
* 認証について

<br>

## タスク 1 : App Service ログの設定と有効化

一般的な Web サーバーの場合、既定の状態でアクセスログやエラーログなどのログが出力されますが、App Service では既定ではログが出力されないため、ログの設定と有効化を行う必要があります。

ログの出力先は Azure Storage (Blob) と  App Service ファイル システムの 2 種類がありますがこのタスクでは Azure Storage アカウントを使用します。

ログの出力先となる Azure Storage アカウントは \[**App Service ログ**\]の設定画面から作成することもできますが、混乱を避けるためにAzure Storage アカウントの作成と、\[**App Service ログ**\] の設定手順を別けて説明します。

はじめに Azure Storage アカウントを作成します。

具体的な手順は以下の通りです。

### タスク 1.1 : Azure Storage アカウントの作成

1. [Azure Portal](http://portal.azure.com) にログインします。

2. ポータル画面上部の \[**+**\] リソースの作成 アイコンか、表示されていない場合は画面左上のハンバーガーメニューをクリックし、\[**リソースの作成**\] をクリックします

    <img src="images/23aug_create_AzureResource.png" width="700px">

3. \[**リソースの作成**\] 画面に遷移するので、検索ボックスに `ストレージ` と入力し、表示された検索結果の \[**ストレージ アカウント**\] のタイルをクリックします

    <img src="images/storage_find_result.png" width="700px">

4. \[**ストレージ アカウント**\] の画面が表示されるので、\[**作成**\] ボタンをクリックします

5. \[**ストレージ アカウントを作成する**\] 画面に遷移するので、各項目を以下の通り入力します

    |項目|値|
    |---|---|
    |サブスクリプション|使用するサブスクリプション|
    |リソース グループ|`PaaS_Handson`|
    |ストレージ アカウント名|`handsonstorage99`(※1)|
    | 地域 * | \[**(Asia Paciffic) Japan East**\] |
    |パフォーマンス|\[**Standard**\]|
    |冗長性|\[**ローカル冗長ストレージ(LRS)**\](※2)|
    |ロケーション|使用するリージョン|

    (※1) この名前はユニークでかつ小文字英数字しか使用できないため、数字 `99` を任意の数字に書き換えてください。

    (※2) 今回は演習で使用するため価格の安い LRS を指定しています。実際に運用する際は、データの重要度に応じて GRS などの冗長性の高いものを選択してください。

    <img src="images/storage_create_settings.png" width="700px">

    \[**レビュー**\] ボタンをクリックし、\[**作成**]\ ボタンが表示されたらクリックしデプロイを開始します。

6. デプロイが完了すると \[**リソースに移動**\] ボタンが表示されるので、クリックして作成された Azure Storage アカウントの画面に遷移します

7. 画面左のメニューバーから \[**コンテナー**\] をクリックし、遷移した画面上部にある \[ **+ コンテナー**\] ボタンをクリックします

    画面右側に \[**新しいコンテナー**\] ブレードが表示されるので、以下の 2 つの名前のコンテナーをそれぞれ作成します

    * **log-server**
    * **log-app**

    > 【メモ】既定で $logs という名前のコンテナーが作成されていることがありますが、このコンテナーは Azure Storage Analytics ログを保存するもので削除することはできません。詳しくは以下のドキュメントを参照してください。
    > * [Azure Storage Analytics ログ - ログの保存方法](https://learn.microsoft.com/ja-jp/azure/storage/common/storage-analytics-logging#how-logs-are-stored)

    <img src="images/storage_blob_containar_new.png" width="700px">

ここまでの手順で Azure Storage アカウントの作成と、ログを保存するためのコンテナーの作成が完了です。

次に App Service のログの設定を行います。

### タスク 1.2 : App Service ログの設定

1. [Azure Portal](http://portal.azure.com) にログインします

2. [演習 1 のタスク 3](ex01.md#%E3%82%BF%E3%82%B9%E3%82%AF-3-appservice-%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%AE%E4%BD%9C%E6%88%90) で作成した App Service **MovieApp-** XYZ の設定画面を開きます

3. 画面左側のメニューから \[**App Service ログ**\] をクリックします

    遷移した画面で \[**アプリケーション ログの記録 (BLOB)**\] トグルボタンを \[**オン**\] にし、 項目 \[**ストレージ コンテナー**\] の下にある \[**()**\] リンクをクリックします

    <img src="images/AppService_setting_AppLog.png" width="700px">

4. ストレージ アカウントの一覧が表示されるので タスク 1.1 で作成し
た `handsonstorage99` をクリックします

    続いてコンテナーの一覧が表示されるので、\[**log-app**\] コンテナーを選択し、\[**選択**\] ボタンをクリックします

    <img src="images/AppService_log_Storage_setting01.png" width="700px">

5. \[**App Service ログ**\] の画面に戻るので、\[**リテンション機関 (日)\***\] を任意の日数に設定します

6. \[**サーバー ログ**\] のトグルボタンを \[**ストレージ**\] にし、 項目 \[**ストレージ コンテナー**\] の下にある \[**()**\] リンクをクリックします

    この手順の 4 と同様に、ストレージ アカウントの一覧が表示されるので `handsonstorage99` をクリックし、コンテナーの一覧が表示されるので、\[**log-server**\] コンテナーを選択し、\[**選択**\] ボタンをクリックします
    
7. \[**App Service ログ**\] の画面に戻るので、\[**リテンション機関 (日)\***\] を任意の日数に設定します

8. \[**詳細なエラー メッセージ**\]、\[**失敗した要求のトレース**\] のトグルボタンを \[**オン**\] にし、画面上部にある \[**保存**] ボタンをクリックします

    ここまでの手順で App Service のログの設定が完了です。
<br>

### タスク 1.3 : App Service ログの取得と確認

実際に App Service のアプリケーションにアクセスを行い Web サーバーログにアクセスログを、アプリケーションにエラーを発生させアプリケーションログに情報を取得します。

手順は以下のとおりです。

1. 画面左側のメニューから \[**概要**\] をクリックし、遷移した画面の \[**既定のドメイン**\] リンクをクリックし、Web ブラウザで App Service のアプリケーションにアクセスします

2. アプリケーションの画面が表示されたら、画面上部の \[**Create New**\] リンクをクリックしします。
    
    <img src="images/MovieApp_CreateNew.png" width="700px">

    映画情報の新規登録画面に任意の情報を入力して \[**Create**\] ボタンをクリックすると最初の画面に遷移するので追加した映画がリストに表示されていることを確認します。

3. Web ブラウザーのアドレスバーに表示されているアプリケーションの URL を以下のように書き換え、SPA の画面を表示します。ドメイン名の後ろに `/index.html` を必ず付けてください。

    `https://<App Service の名前>.azurewebsites.net/index.html`

    アプリケーションのタイトルが `Movies SPA` に変わっていることを確認します

    この SPA で使用している編集 API は HTTP500 エラーを返すようになっているのでこれを使用してエラーを発生させ、アプリケーション ログにエラー情報を取得します

4. リストされている映画のタイトルから、このタスクで追加した映画の \[**Edit**\] リンクをクリックし、遷移した編集画面で \[**Save**\] ボタンをクリックします

   画面は遷移しませんが、エラーは発生しているので、以降の手順でログに記録されているエラーを確認します。

5. この演習の[タスク 1.1](#%E3%82%BF%E3%82%B9%E3%82%AF-11--azure-storage-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90) で作成した Azure Storage アカウントの画面を開き、画面左側のメニューから \[**コンテナー**\] をクリックします

6. コンテナーの一覧が表示されるので、\[**log-server**\] コンテナーをクリックします
    <img src="images/MovieApp_CreateNew.png" width="700px">





