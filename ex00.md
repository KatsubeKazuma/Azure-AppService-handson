# 演習 0 : 富士通のルールに則ったリソース作成

富士通のプロジェクトでリソース作成を行う際、インターネット公開が必要なサービスが存在する場合

富士通内でセキュリティ検査を実施する必要があります。

一般的には上記申請が完了するまでは、プライベートな環境での構築が必要となります。

そのため、このアプリケーションを ルールに則り正しく動作させるには Azure ApplicationGatewayのほかにAzure WAF をデプロイし外部からの接続を制限する必要があります。

よって、この演習の手順は以下の 3 つとなります。

1. [**Azure ApplicationGatewayの作成**](#%E3%82%BF%E3%82%B9%E3%82%AF-1-azure-applicationgateway%E3%81%AE%E4%BD%9C%E6%88%90)
2. [**Azure WAFの作成**](#%E3%82%BF%E3%82%B9%E3%82%AF-2-azure-waf%E3%81%AE%E4%BD%9C%E6%88%90)
3. [**Azure WAFへのルールの追加**](#%E3%82%BF%E3%82%B9%E3%82%AF-3-azure-waf%E3%81%B8%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%BF%BD%E5%8A%A0)

## 事前作成リソースと本演習で作成するリソース

事務局側で作成したリソースの構成図は以下になります。

以下の環境がチーム別に準備されています。
    ![Create Resource](images/20240710_事前作成構成図.JPG)

本演習を通して以下の構成図になるようリソース作成を進めていきます。

    ![Create Resource](images/20240710_演習0作成構成図.JPG)

## タスク 1. Azure ApplicationGatewayの作成

Azure Portal から Azure SQL Database インスタンスを作成します。

具体的な手順は以下の通りです。

1. [Azure Portal](http://portal.azure.com) にログインします。

2. ポータル画面上部の \[**+**\] リソースの作成 アイコンか、表示されていない場合は画面左上のハンバーガーメニューをクリックし、\[**リソースの作成**\] をクリックします

    ![Create Resource](images/23aug_create_AzureResource.png)

3. \[**リソースの作成**\] 画面に遷移するので、検索ボックスに `SQL` と入力し、表示された検索結果の \[**Azure SQL**\] のタイルをクリックします

    ![Search SQL Database](images/AzureSQL_tail.png)

4. \[**Azure SQL**\] の画面に遷移するので、\[**作成**\] ボタンをクリックします

    ![Create SQL Database](images/AzuzeSQL_makeFree.png)

5. \[**SQL デプロイ オプションを選択する**\] 画面に遷移するので、\[**SQL データベース**\] のタイル内の \[リソースの種類\] ドロップボックスの内容が `単一データベース` になっていることを確認し、\[**作成**\] ボタンをクリックします

    ![Select SQL Database](images/AzuzeSQL_Option.png)

6. \[**SQL データベースの作成**\] 画面に遷移するので、以下のように設定します
    
    | 設定項目 | 設定値 |
    |:--|:--|
    | サブスクリプション | ご利用のサブスクリプション |
    | リソース グループ | <u>新規作成</u> をクリックして `PaaS_Handson` という名前で作成 |
    | データベース名 | `hands-on-db` |
    | サーバー | \[**新規作成**\] をクリック |
    |(サーバーの作成画面) サーバー名 | `handson-sqlserver-XYZ`(※) |
    |(サーバーの作成画面) サーバーの場所 | `(Asia Pacific) Japan East` |
    |(サーバーの作成画面) 認証方法 | \[**SQL と Azure Entra 認証の両方を使用する**\] にチェック|
    |(サーバーの作成画面) Azure AD 管理者の設定をする | \[**管理者の設定**\] リンクをクリックして現在 Azure にログインしているユーザーアカウントを指定 |
    |(サーバーの作成画面) サーバー管理者のログイン | `handson-sqladmin` |
    |(サーバーの作成画面) パスワード | `P@ssw0rd1234` |
    |(サーバーの作成画面) パスワードの確認 | `P@ssw0rd1234` |
    | SQL エラスティック プールを使用しますか?| \[**いいえ**\] |
    | ワークロード環境 | \[**開発**\] |
    | コンピューティングとストレージ | (既定のまま) |
    | バックアップ ストレージの冗長性| \[**ローカル冗長ストレージ (LRS)**\] |
    
    (※) この名前はユニークである必要があります。`hands-on-server-XYZ` の `XYZ` を任意の文字列に置き換えてください。

    \[**確認および作成**\] ボタンをクリックし\[**作成**\] ボタンが表示されたらクリックします。

7. デプロイが完了すると \[**リソースに移動**\] ボタンが表示されますが、今回作成したデータベース `hands-on-db` は使用せず、このあとのタスク 2 の手順でローカル環境からエクスポートしたデータベースを使用しますので、\[**リソースに移動**\] ボタンはクリックせずに、\[**閉じる**\] ボタンをクリックして画面を閉じます

9. 作成した **Azure SQL サーバー** の画面を表示します。これには Azure ポータルのホーム画面で作成した Azure SQL サーバー名  `handson-sqlserver-XYZ` を検索するか、Azure SQL データベースの画面の \[**概要**\] タブ内の \[**サーバー名**\] をクリックして表示される画面の \[**サーバー名**\] をクリックします

10. Azure SQL データベースの画面に遷移したら、左のメニューから \[**ネットワーク**\] をクリックします

11. \[**ネットワーク**\] 画面に遷移するので \[**パブリック ネットワーク アクセス**\] で \[**選択したネットワーク**\] をチェックします

    \[**ファイアーウォール規則**\] のところに既にお使いのクライアントの IP アドレスが設定されたメニュー \[**+ クライアント IPv4 アドレス(%IPアドレス%) の追加**\] メニューがあるので(※)、これをクリックします

    (※)もし、IP アドレスが自動設定されていない場合は `ipconfig` コマンド等でローカル環境の IP アドレスを確認し、手動で設定してください。

    \[**例外**\] のセクションにある \[**Azure サービスおよびリソースにこのサーバーへのアクセスを許可する**\] にチェックを入れ、\[**保存**\] ボタンをクリックします

    ![Enable Public Network Access](images/AzureSQL_publicAccess.png)


ここまでの手順で Azure SQL Database のインスタンスが作成され、データベース移行作業に必要となる Azure SQL Database への接続文字列を取得し、開発環境からの接続を許可する設定が完了しました。

<br>

## タスク 2. Azure WAFの作成

Visual Studio 開発用データベースの内容を Azure SQL Database に移行します。この作業には SQL Management Studio を使用して行いますが、ローカルで動作しているデータベースの名前を確認するためと、データベースを起動した状態とするために Visual Studio で演習用アプリケーションのプロジェクトを開いたまま作業を行います。

具体的な手順は以下の通りです。

1. Visual Studio で演習用アプリケーションのプロジェクトを開きます

2. メニューバーから \[**表示**\] > \[**SQL サーバー オブジェクト　エクスプローラー**\] をクリックします

3. **SQL サーバー オブジェクト　エクスプローラー** が表示されるので、同画面のツリーから \[SQL Server\] - \[(localdb)\MSSQLLocalDB(SQL Server %バージョン%)\] - \[データベース\] - \[**MvcMovieContext-%GUID%**\] を右クリックし、表示されたコンテキスト メニューから \[**プロパティ**\] をクリックします

    ![Open Property](images/property_sql_localdb.png)

4. \[**プロパティ**\] 画面が表示されるので、\[**サーバー**\] の値をコピーしてメモ帳などに保持しておきます

    ![Copy Server Name](images/sql_localserver_name.png)

    >【注意】 Visual Studio 開発用データベース(SQL Server Express LocalDB) への接続文字列はプロジェクト中の appsettings.json に記述されていますが、この内容はエスケープ文字が混じっており、そのままでは他のツールで使用できません。そのため、SQL Server 名や接続文字列を取得する際には、Visual Studio 開発用データベースのプロパティ画面から取得することをお勧めします。

    なお、データベースの移行作業が完了するまで Visual Studio は起動したままにしておきます。これは Visual Studio が終了すると開発用データベースに接続できなくなってしまうためです。

5. SQL Server Management Studio を起動します

    \[**サーバーへの接続**\] ダイアログボックスが表示されるので、以下のように設定します。

    | 設定項目 | 設定値 |
    |:--|:--|
    | サーバー種類 | \[データベース エンジン\] |
    | サーバー名 | 前の手順で保持しておいた Visual Studio 開発用データベースのサーバー名 |
    | 認証 | \[Windows 認証\] |

    \[**接続**\] ボタンをクリックします

    ![Connect to SQL Server](images/sql_connect_dialog.png)

6. \[オブジェクト エクスプローラー\] にデータベースのツリーが表示されるので、\[(localdb)\MSSQLLocalDB(SQL Server %バージョン%)\] - \[データベース\] - \[**MvcMovieContext-%GUID%**\] を右クリックし、表示されたコンテキスト メニューから \[**タスク**\] > \[**Microsoft Azure SQL Database へのデータベースの配置...**\] をクリックします

    ![Export Database](images/sql_export_database.png)

7. \[**配置の設定**\] ダイアログボックスが表示されるので、\[**接続**\] ボタンをクリックします。

    \[**サーバーへの接続**\] ダイアログボックスが表示されるので、各項目を以下のように設定します。

    | 設定項目 | 設定値 |
    |:--|:--|
    | サーバー種類 | \[データベース エンジン\] |
    | サーバー名 | `演習 1-1 で作成した Azure SQL サーバーの名前(※)`|
    | 認証 | \[SQL Server 認証\] |
    | ログイン | `handson-sqladmin` |
    | パスワード | `P@ssw0rd1234` |

    (※) 前の手順 [**1. Azure SQL Database インスタンスの作成**](#1-azure-sql-database-%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%AE%E4%BD%9C%E6%88%90) でコピーしておいた接続文字列からサーバー名を取得し、\[**サーバー名**\] に貼り付けます

    ![Azure SQL Servre への接続ダイアログボックス](images/sql_azure_connect_dialog.png)

    \[**接続**\] ボタンをクリックすると、\[**配置の設定**\] ダイアログボックスに戻るので、他の設定は既定のまま \[次へ\] ボタンをクリックします

8. \[指定して設定の検証\] 画面に遷移するので、\[**完了**\] ボタンをクリックすると、データベースの移行作業が開始され、\[進行状況\] が表示されるので、完了するまで待ちます

9. 移行作業が完了すると、\[**結果**\] 画面に遷移するので、すべての操作の結果が `成功`であることを確認し、\[**閉じる**\] ボタンをクリックします

    ![Export Database Result](images/AzureSQL_Export_done.png)

    ここまでの手順で、Visual Studio 開発用データベースの内容が Azure SQL Database に移行されたはずですが、念のために SQL Management Server から Azure SQL Database に接続してデータベースの内容を確認します。

10. \[オブジェクト エクスプローラー\] 上部の \[オブジェクト エクスプローラーを接続\] ボタンをクリックします

    ![Connect Object Explorer](images/sql_connect_object_explorer.png)

11. \[**サーバーへの接続**\] ダイアログボックスが、接続情報が設定された状態で表示されるので \[**接続**\] ボタンをクリックします

12. 接続が成功すると \[オブジェクト エクスプローラー\] に Azure Database のツリーが表示されるので、\[**データベース**\] - \[**MvcMovieContext-%GUID%**\] - \[**テーブル**\] - \[**dbo.Movie**\]を右クリックし、表示されたコンテキスト メニューから \[**上位 1000 行の選択**\] をクリックします

    ![Show Data](images/sql_show_data.png) 

    クエリーが実行されて、データベースの内容が表示されます。ここで、ローカルの開発環境で作成したデータベースの内容が Azure SQL Database に移行されていることが確認できました。

    ![Show Data Result](images/sql_show_data_result.png)

13. ここまでの作業で Azure SQL Server にエクスポートしたデータベースへの接続文字列を取得します

    \[オブジェクト エクスプローラー\] でエクスポートしたデータベースのツリーを右クリックし、表示されたコンテキスト メニューから \[**管理ポータルで開く**\] をクリックします。

    ![Open Management Portal](images/sql_mgr_openPortal.png)


    Web ブラウザーに Azure Portal が開き、Azure 上の SQL Database の一覧が表示されるので、エクスポートしたデータベースをクリックします

14. 選択したデータベースの設定画面に遷移するので、画面左のメニューから \[**接続文字列**\] をクリックし、遷移した画面の \[**ADO.NET**\] タブ内の \[**ADO.NET (SQL 認証)**\]接続文字列をコピーして、メモ帳などで保持しておきます

    ![Copy Connection String](images/AzureSQL_ConnectionString.png)



ここまでの作業で Visual Studio 開発用データベースを Azure SQL Database に移行する作業と接続情報の取得は完了です。

**【重要】**

実運用システムのデータベースを移行する際は、データベース内のテーブルやレコードだけでなく、データベースをホストしているデータベース サーバーのシステム構成や、その他の情報も含めて移行が必要必要となる場合があります。そのため、実運用システムのデータベースを Azure SQL Database に移行する場合は必ずデータベースの専門家に作業を依頼してください。

<br>

## タスク 3. Azure WAFへのルールの追加

演習用アプリケーションのデプロイ先となる Azure AppService インスタンスを作成します。

Visual Studio は、Azure AppService に対してデプロイするための設定を行うためのツールを提供しています。このツールを使用すると、Azure AppService の作成も行えますが、作業内容を分けるためにここでは Azure Portal から作成する手順を説明します。

具体的な手順は以下の通りです。

1. Azure ポータルにサインインします

    https://portal.azure.com

2. ポータル画面上部の \[**+**\] リソースの作成 アイコンか、表示されていない場合は画面左上のハンバーガーメニューをクリックし、\[**リソースの作成**\] をクリックします

    ![Create Resource](images/23aug_create_AzureResource.png)

3. 多くの場合、遷移した画面に \[**Web アプリ**\] がリストされているはずですが、

    ![Search Web App](images/23aug_listedWebApp.png)

    もしリストされていない場合は画面左のメニューから \[**Web**\]をクリックししてください。

4. \[**Web アプリ**\]のタイルをクリックすると、\[**Web アプリの作成**\] 画面が表示されます

    ![Web App Tile](images/23Sep_createWebApps.png)

    設定項目は以下のとおりです。

    
    |  項目  |  値  |
    | ---- | ---- |   
    | サブスクリプション * | 使用する Azure サブスクリプション |
    | リソースグループ * | `PaaS_Handson` |
    | 名前 * | `MovieApp-XYZ`(※1)|
    | 公開 * | **コード**|
    | ランタイム スタック * | **.NET 8 (LTS)** |
    | オペレーティングシステム * | **Windows** |
    | 地域 * | **(Asia Paciffic) Japan East** |
    | App Service プラン(場所) * | 既定のまま |
    | 価格プラン * | **Free F1 (共有インフラストラクチャ)** |

    (※1) この名前はユニークである必要があります。`MovieApp-XYZ` の `XYZ` を任意の文字列に置き換えてください。

    (※2) この手順では開発検証用の無料プランを使用します。ただし、無料プランでは AppService のインスタンスが 1 つしか作成できないため、デプロイスロット、スケールアウト設定が行えません。これらの機能を使用するには、AppService のプランを変更する必要があります。
    詳細は [**Azure App Service プランの概要**](https://learn.microsoft.com/ja-jp/azure/app-service/overview-hosting-plans) を参照してください。

    運用環境では Standard 以上のプランを使用することをお勧めします。以降の手順では必要に応じてプランを変更して演習を行います。

5. フォームへの入力が完了したら \[**確認および作成**\] ボタンをクリックし、ボタンの表示が \[**作成**\] に変わったらクリックします。 

    AppService のデプロイが開始されます。

6. デプロイが完了すると、\[**リソースに移動**\] ボタンが表示されるのでクリックします

7. 作成した AppService の画面の \[**概要**\] 画面に遷移するので、同画面内の \[**既定のドメイン**\] をクリックすると、ブラウザで AppService のトップページが表示されることを確認します

    ![AppService Top Page](images/AppService_TopPage.png)

    ここまでの手順で、AppService インスタンスが作成されました。

<!--
8. 最後に、Visual Studio から直接デプロイするのに必要となる **SCM 基本認証の発行資格情報**を有効にします。

    作成した AppService の画面の左側のメニューから \[**構成**\] をクリックし、遷移した画面の \[**全般設定**\] タブ内の \[**SCM 基本認証の発行資格情報**\] の設定を \[**オン**\] に変更し、\[**保存**\] ボタンをクリックします。

    <img src="images/AppService_Setting_SCM.png" width="500px">
-->

> 【メモ】 2024 年 6 月から App Service 作成画面に [**一意の既定のホスト名(Unique Default Hostname)**](https://techcommunity.microsoft.com/t5/apps-on-azure-blog/public-preview-creating-web-app-with-a-unique-default-hostname/ba-p/4156353) という機能が追加されました。
> <img src="images/AppService_UniqueHostName.png" width="300px">

> これは App Service インスタンス作成時に提供される URL 中のサブドメイン名を提供するものです。これによりリソースを削除した後に他者がそのサブドメインを使用して成り済ますなどの問題を回避することができます。

次のタスクでは Visual Studio から直接 AppService にアプリケーションをデプロイします。

<br>


## まとめ

この演習では、富士通でAzure構築を行う際の注意点を一般的な進め方について体験しました。

インターネットに公開する際は、以下のインターネット接続のセキュリティ検査を環境に応じて実施してください。

* [**インターネット接続のセキュリティ検査**](https://fujitsu.sharepoint.com/sites/jp-diagtech)



<!--
追加するリソース
https://techcommunity.microsoft.com/t5/apps-on-azure-blog/checklist-for-migrating-web-apps-to-app-service/ba-p/3810991

移行について
https://learn.microsoft.com/ja-jp/azure/app-service/app-service-migration-assess-net

https://learn.microsoft.com/ja-jp/azure/app-service/app-service-java-migration

-->

<br>

---
👉 : [**演習2) Web サイトを運用するための基本的な設定**](ex01.md)へ

👈 : [**アカウントの確認とサンプル アプリケーションの入手**](preparation.md)へ

🏚️ :  [**README**](README.md)
